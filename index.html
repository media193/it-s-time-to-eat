<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onChildAdded, onChildRemoved, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// ---------------- Firebase 設定 ----------------
const firebaseConfig = {
  apiKey: "AIzaSyA8Qa_69erE3FNr-XKzXFN_81iPYXyqHfI",
  databaseURL: "https://its-time-to-eat-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "its-time-to-eat",
  appId: "1:47758464256:web:1d7b4e5830aab3ab7f4fe5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const userId = crypto.randomUUID(); // セッションごとのユニークID
const userPhotoRef = ref(db, `photos/${userId}`);
const photosRef = ref(db, "photos");

// ---------------- DOM ----------------
const startWrapper = document.getElementById("startWrapper");
const startButton = document.getElementById("startButton");
const endButton = document.getElementById("endButton");
const cameraArea = document.getElementById("cameraArea");
const shutter = document.getElementById("shutter");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const photoArea = document.getElementById("photoArea");
const flash = document.getElementById("flash");
const message = document.getElementById("message");

// ---------------- 状態管理 ----------------
let stream = null;
let phase = "wait"; // wait=未投稿、eat=いただきます、end=ごちそうさま
const displayedPhotos = new Map(); // 現在表示中の写真管理

// ---------------- カメラ ----------------
async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } });
    video.srcObject = stream;
  } catch (err) {
    alert("カメラにアクセスできません: " + err.message);
  }
}

function stopCamera() {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
}

function takePhoto() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);
  return canvas.toDataURL("image/jpeg", 0.7);
}

function flashEffect() {
  flash.style.opacity = 1;
  setTimeout(() => flash.style.opacity = 0, 100);
}

// ---------------- いただきますボタン ----------------
startButton.onclick = async () => {
  phase = "eat";
  startWrapper.style.display = "none"; // ボタン非表示
  cameraArea.style.display = "block";
  message.textContent = "今日のご飯は？";
  await startCamera();

  photoArea.innerHTML = ""; // 過去写真は非表示
  displayedPhotos.clear();
};

// ---------------- ごちそうさまボタン ----------------
endButton.onclick = async () => {
  phase = "end";
  endButton.style.display = "none";
  cameraArea.style.display = "block";
  message.textContent = "どんな時間でしたか";
  await startCamera();
};

// ---------------- シャッター ----------------
shutter.onclick = async () => {
  flashEffect();
  const image = takePhoto();
  stopCamera();
  cameraArea.style.display = "none";

  // 自分の写真を投稿（追加/更新）
  await set(userPhotoRef, {
    image,
    updatedAt: Date.now()
  });

  if (phase === "eat") {
    endButton.style.display = "block";
  } else { // ごちそうさま後
    setTimeout(async () => {
      await remove(userPhotoRef); // 他ユーザー画面からも消える
      startWrapper.style.display = "flex"; // ボタン復活
      photoArea.innerHTML = "";
      displayedPhotos.clear();
      phase = "wait"; // 初期状態に戻す
    }, 5000);
  }
};

// ---------------- リアルタイム表示 ----------------

// 写真追加
onChildAdded(photosRef, snapshot => {
  const data = snapshot.val();
  if (!data || !data.image) return;

  // 自分がまだいただきますしていなければ表示しない
  if (phase === "wait") return;

  // すでに表示済みの写真は重複表示しない
  if (displayedPhotos.has(snapshot.key)) return;

  const img = document.createElement("img");
  img.src = data.image;
  img.dataset.key = snapshot.key;
  photoArea.appendChild(img);

  displayedPhotos.set(snapshot.key, img);
});

// 写真削除
onChildRemoved(photosRef, snapshot => {
  const key = snapshot.key;
  const img = displayedPhotos.get(key);
  if (img) {
    img.remove();
    displayedPhotos.delete(key);
  }
});
</script>
