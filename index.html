import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase,
  ref,
  set,
  remove,
  onValue,
  runTransaction
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* Firebase設定 */
const firebaseConfig = {
  apiKey: "...",
  authDomain: "...",
  databaseURL: "...",
  projectId: "...",
  storageBucket: "...",
  messagingSenderId: "...",
  appId: "..."
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const countRef = ref(db, "eatingCount");
const sessionsRef = ref(db, "sessions");

/* DOM */
const button = document.getElementById("mainButton");
const video = document.getElementById("camera");
const canvas = document.getElementById("canvas");

/* 状態 */
const userId = crypto.randomUUID();
let stream = null;
let step = "idle"; // idle | eating | finishing

/* 人数に応じてボタンサイズ */
onValue(countRef, (snap) => {
  const count = snap.val() ?? 0;
  const size = 120 + count * 15;
  button.style.width = size + "px";
  button.style.height = size + "px";
});

/* 他人の写真を表示 */
onValue(sessionsRef, (snap) => {
  document.querySelectorAll(".shared-photo").forEach(el => el.remove());

  snap.forEach(child => {
    if (child.key === userId) return;

    const img = document.createElement("img");
    img.src = child.val().photo;
    img.className = "shared-photo";
    img.style.width = "120px";
    img.style.margin = "8px";
    document.body.appendChild(img);
  });
});

/* カメラ */
async function startCamera() {
  stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
  video.style.display = "block";
}

function shoot() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);
  stream.getTracks().forEach(t => t.stop());
  video.style.display = "none";
  return canvas.toDataURL("image/jpeg");
}

/* 写真を共有 */
function sharePhoto(dataURL) {
  set(ref(db, `sessions/${userId}`), {
    photo: dataURL,
    updatedAt: Date.now()
  });
}

/* セッション削除 */
function clearSession() {
  remove(ref(db, `sessions/${userId}`));
}

/* ボタン挙動 */
button.onclick = async () => {

  /* いただきます */
  if (step === "idle") {
    step = "eating";
    button.textContent = "ごちそうさま";
    runTransaction(countRef, c => (c || 0) + 1);

    await startCamera();
    setTimeout(() => {
      const photo = shoot();
      sharePhoto(photo);
    }, 1500);
  }

  /* ごちそうさま */
  else if (step === "eating") {
    step = "finishing";

    await startCamera();
    setTimeout(() => {
      const photo = shoot();
      sharePhoto(photo);

      setTimeout(() => {
        clearSession();
        runTransaction(countRef, c => Math.max((c || 1) - 1, 0));
        location.reload();
      }, 5000);

    }, 1500);
  }
};
