<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>いただきます</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">


<style>
body {
 margin: 0;
 background: #fafafa;
 font-family: sans-serif;
}


#photos {
 padding: 10px;
}


.photo {
 margin-bottom: 8px;
}


.photo img {
 width: 120px; /* ★ 少し小さく */
 border-radius: 6px;
}


/* カメラ */
#cameraArea {
 display: none;
 position: relative;
}


#message {
 position: absolute;
 top: 10px;
 width: 100%;
 text-align: center;
 color: white;
 font-size: 16px;
 text-shadow: 0 0 6px rgba(0,0,0,0.6);
}


video {
 width: 100%;
}


#shutter {
 position: absolute;
 bottom: 20px;
 left: 50%;
 transform: translateX(-50%);
 width: 70px;
 height: 70px;
 border-radius: 50%;
 background: white;
 border: 4px solid #ddd;
}


#shutter::after {
 content: "";
 display: block;
 width: 52px;
 height: 52px;
 margin: 5px auto;
 border-radius: 50%;
 background: #eee;
}


/* ボタン */
.circleButton {
 width: 180px;
 height: 180px;
 border-radius: 50%;
 border: none;
 background: white;
 font-size: 22px;
 margin: 40px auto;
 display: block;
 box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}


#flash {
 position: fixed;
 inset: 0;
 background: white;
 opacity: 0;
 pointer-events: none;
}


canvas {
 display: none;
}
</style>
</head>


<body>


<div id="photos"></div>


<button id="startButton" class="circleButton">いただきます</button>


<div id="cameraArea">
 <div id="message">今日のご飯は？</div>
 <video id="video" autoplay playsinline></video>
 <button id="shutter"></button>
</div>


<button id="endButton" class="circleButton" style="display:none;">ごちそうさま</button>


<div id="flash"></div>
<canvas id="canvas"></canvas>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";


const firebaseConfig = {
 apiKey: "AIzaSyA8Qa_69erE3FNr-XKzXFN_81iPYXyqHfI",
 databaseURL: "https://its-time-to-eat-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId: "its-time-to-eat",
 appId: "1:47758464256:web:1d7b4e5830aab3ab7f4fe5"
};


const app = initializeApp(firebaseConfig);
const db = getDatabase(app);


// 自分専用ID（リロードごとに新規）
const userId = crypto.randomUUID();
const myRef = ref(db, `photos/${userId}`);
const photosRef = ref(db, "photos");


const startButton = document.getElementById("startButton");
const endButton = document.getElementById("endButton");
const cameraArea = document.getElementById("cameraArea");
const shutter = document.getElementById("shutter");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const photos = document.getElementById("photos");
const flash = document.getElementById("flash");


let stream = null;
let phase = "eat";
let hasJoined = false; // ★ 自分が参加したかどうか


async function startCamera() {
 stream = await navigator.mediaDevices.getUserMedia({ video: true });
 video.srcObject = stream;
}


function stopCamera() {
 if (stream) {
   stream.getTracks().forEach(t => t.stop());
   stream = null;
 }
}


function takePhoto() {
 canvas.width = video.videoWidth;
 canvas.height = video.videoHeight;
 canvas.getContext("2d").drawImage(video, 0, 0);
 return canvas.toDataURL("image/jpeg", 0.7);
}


function flashEffect() {
 flash.style.opacity = 1;
 setTimeout(() => flash.style.opacity = 0, 100);
}


/* いただきます */
startButton.onclick = async () => {
 phase = "eat";
 startButton.style.display = "none";
 cameraArea.style.display = "block";
 await startCamera();
};


/* ごちそうさま */
endButton.onclick = async () => {
 phase = "end";
 endButton.style.display = "none";
 cameraArea.style.display = "block";
 await startCamera();
};


/* シャッター */
shutter.onclick = async () => {
 flashEffect();
 const image = takePhoto();
 stopCamera();
 cameraArea.style.display = "none";


 if (phase === "eat") {
 hasJoined = true; // ★ 先に参加状態にする
}


await set(myRef, {
 image,
 phase,
 updatedAt: Date.now()
});


if (phase === "eat") {
 endButton.style.display = "block";
} else {
 setTimeout(async () => {
   await remove(myRef);
   hasJoined = false;
   photos.innerHTML = "";
   startButton.style.display = "block";
 }, 5000);
}
};


/* 表示ロジック */
onValue(photosRef, snapshot => {
 if (!hasJoined) return; // ★ 参加前は何も見せない


 photos.innerHTML = "";
 const now = Date.now();


 snapshot.forEach(child => {
   const data = child.val();


   if (
     data.phase === "eat" ||
     (data.phase === "end" && now - data.updatedAt < 5000)
   ) {
     const div = document.createElement("div");
     div.className = "photo";


     const img = document.createElement("img");
     img.src = data.image;


     div.appendChild(img);
     photos.appendChild(div);
   }
 });
});
</script>


</body>
</html>



