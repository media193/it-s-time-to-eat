<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onChildAdded, onChildRemoved, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA8Qa_69erE3FNr-XKzXFN_81iPYXyqHfI",
  databaseURL: "https://its-time-to-eat-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "its-time-to-eat",
  appId: "1:47758464256:web:1d7b4e5830aab3ab7f4fe5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const userId = crypto.randomUUID(); // 自分のセッションID
const userPhotoRef = ref(db, `photos/${userId}`);
const photosRef = ref(db, "photos");

const startWrapper = document.getElementById("startWrapper");
const startButton = document.getElementById("startButton");
const endButton = document.getElementById("endButton");
const cameraArea = document.getElementById("cameraArea");
const shutter = document.getElementById("shutter");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const photoArea = document.getElementById("photoArea");
const flash = document.getElementById("flash");
const message = document.getElementById("message");

let stream = null;
let phase = "eat";
let hasStarted = false; // ★「いただきます」押したか

async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } });
    video.srcObject = stream;
  } catch (err) {
    alert("カメラにアクセスできません: " + err.message);
  }
}

function stopCamera() {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
}

function takePhoto() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);
  return canvas.toDataURL("image/jpeg", 0.7);
}

function flashEffect() {
  flash.style.opacity = 1;
  setTimeout(() => flash.style.opacity = 0, 100);
}

/* いただきます */
startButton.onclick = async () => {
  phase = "eat";
  hasStarted = true; // ★
  startWrapper.style.display = "none";
  cameraArea.style.display = "block";
  message.textContent = "今日のご飯は？";
  await startCamera();
  photoArea.innerHTML = ""; // 初期表示で他人の写真非表示
  renderExistingPhotos(); // ★過去の他人写真を描画
};

/* ごちそうさま */
endButton.onclick = async () => {
  phase = "end";
  endButton.style.display = "none";
  cameraArea.style.display = "block";
  message.textContent = "どんな時間でしたか";
  await startCamera();
};

// ★自分と他人の写真を管理するオブジェクト
const displayedPhotos = {};

function renderPhoto(id, data, isSelf) {
  const img = document.createElement("img");
  img.src = data.image;
  img.dataset.id = id;
  photoArea.appendChild(img);
  displayedPhotos[id] = img;
}

function removePhoto(id) {
  const img = displayedPhotos[id];
  if (img) {
    img.remove();
    delete displayedPhotos[id];
  }
}

// ★初期描画（自分の「いただきます」後に過去写真を表示）
async function renderExistingPhotos() {
  if (!hasStarted) return;
  // Firebaseから現在の写真を取得
  // この部分は簡略化のため、onChildAddedで自分以外を描画
}

/* シャッター */
shutter.onclick = async () => {
  flashEffect();
  const image = takePhoto();
  stopCamera();
  cameraArea.style.display = "none";

  // 自分の写真を投稿
  await set(userPhotoRef, { image, updatedAt: Date.now() });

  if (phase === "eat") {
    endButton.style.display = "block";
  } else {
    setTimeout(async () => {
      await remove(userPhotoRef); // ★削除
      startWrapper.style.display = "flex";
      photoArea.innerHTML = "";
    }, 5000);
  }
};

/* 他ユーザーの写真リアルタイム表示 */
// ★追加: 他人の写真のみ表示。自分の「いただきます」後に描画
onChildAdded(photosRef, snapshot => {
  if (!hasStarted) return; // 自分がまだいただきますしていない場合は描画しない
  const id = snapshot.key;
  if (id === userId) return; // 自分の写真は描画しない
  const data = snapshot.val();
  if (data && data.image) {
    renderPhoto(id, data, false);
  }
});

// ★他人の写真削除をリアルタイム反映
onChildRemoved(photosRef, snapshot => {
  const id = snapshot.key;
  removePhoto(id);
});
</script>
